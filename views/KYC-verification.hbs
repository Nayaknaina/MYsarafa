<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sarafa Community Dashboard</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.5/dist/tesseract.min.js"></script>

  <script src="https://unpkg.com/path-browserify@1.0.1/path.js"></script>
</head>
<style>
  .kyc-form.colorful {
    background: linear-gradient(135deg, #f7fafc 60%, #ffe3ec 100%);
    border-radius: 18px;
    box-shadow: 0 8px 32px rgba(211, 36, 168, 0.10), 0 1.5px 6px rgba(85, 29, 255, 0.08);
    /* border: 4px solid;
  border-image:black */
    
    padding: 36px 32px 28px 32px;
    position: relative;
    overflow: hidden;
  }

  .kyc-form.colorful::before {
    content: '';
    position: absolute;
    top: -60px;
    left: -60px;
    width: 200px;
    height: 120px;
    background: radial-gradient(circle, #D324A8 0%, #551DFF 80%, transparent 100%);
    opacity: 0.12;
    z-index: 0;
  }

  .kyc-form.colorful::after {
    content: '';
   position: absolute;
    bottom: -60px;
    right: -60px;
    width: 200px;
    height: 120px;
    background: radial-gradient(circle, #ffe066 0%, #47ff53 80%, transparent 100%);
    opacity: 0.10;
    z-index: 0;
  }

  .kyc-form.colorful .kyc-section {
    background: white;
    border-radius: 14px;
    box-shadow: 0 2px 12px rgba(211, 36, 168, 0.07);
    padding: 24px 18px 18px 18px;
    margin-bottom: 18px;
    position: relative;
    z-index: 1;
  }

  .kyc-form.colorful .kyc-section-title {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 18px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #fff;
    background: linear-gradient(90deg, #D324A8 0%, #551DFF 100%);
    border-radius: 8px;
    padding: 8px 18px;
    box-shadow: 0 2px 8px rgba(85, 29, 255, 0.10);
  }

  .kyc-form.colorful .kyc-section-title i {
    color: #ffe066;
    text-shadow: 0 2px 8px #551DFF44;
  }

  .kyc-form.colorful .kyc-fields-grid {
    gap: 18px 24px;
  }

  .kyc-form.colorful .form-group label {
    color: black;
    font-weight: 600;
    font-size: 1.05rem;
  }

  .kyc-form.colorful .kyc-input,
  .kyc-form.colorful textarea.kyc-input {
    background: linear-gradient(90deg, #fff 80%, #e3f0ff 100%);
    /* border: 2px solid #D324A8; */
    border-radius: 8px;
    font-size: 1.05rem;
    color: #551DFF;
    box-shadow: 0 1px 6px #D324A822;
    transition: border 0.2s, box-shadow 0.2s;
  }

  .kyc-form.colorful .kyc-input:focus,
  .kyc-form.colorful textarea.kyc-input:focus {
    border: 2px solid #551DFF;
    box-shadow: 0 2px 12px #551DFF33;
    background: #fffbe6;
    color: #D324A8;
  }

  .kyc-form .input-error {
    border-color: #ef4444 !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.12) !important;
  }

  .kyc-form.colorful .add-worker-btn {
    background: linear-gradient(90deg, #47ff53 0%, #2f95ff 100%);
    color: #fff;
    font-weight: 700;
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 8px #47ff5333;
    transition: background 0.2s, box-shadow 0.2s;
  }

  .kyc-form.colorful .add-worker-btn:hover {
    background: linear-gradient(90deg, #2f95ff 0%, #47ff53 100%);
    box-shadow: 0 4px 16px #2f95ff33;
  }

  .kyc-form.colorful .kyc-submit-btn {
    background: white;
    color: black;

    border: none;
    border-radius: 10px;
    font-size: 1.15rem;
    padding: 14px 14px;
    box-shadow: 0 4px 16px #D324A833;
    margin-top: 10px;
    transition: background 0.2s, box-shadow 0.2s;
  }

  .kyc-form.colorful .kyc-submit-btn:hover {
    background: linear-gradient(90deg, #551DFF 0%, #D324A8 100%);
    box-shadow: 0 8px 24px #551DFF33;
  }

  .kyc-form.colorful .form-group input[type="file"] {
    background: #fffbe6;
    border: 2px dashed #ffe066;
    color: #D324A8;
    border-radius: 8px;
    padding: 8px 12px;
  }

  .kyc-form.colorful .form-group small {
    color: #551DFF;
    font-size: 0.95em;
    margin-top: 2px;
  }
  /* Style for OTP input boxes */
.otp-fields {
  display: flex;
  gap: 10px;
  margin-top: 8px;
}

.otp-box {
  width: 40px;
  height: 40px;
  font-size: 1.5rem;
  text-align: center;
  border: 2px solid #551DFF;
  border-radius: 8px;
  background: #fffbe6;
  color: #D324A8;
  box-shadow: 0 1px 6px #D324A822;
  transition: border 0.2s, box-shadow 0.2s;
}

.otp-box:focus {
  border: 2px solid #D324A8;
  box-shadow: 0 2px 12px #551DFF33;
  outline: none;
}

.verify-btn {
  background: linear-gradient(90deg, #551DFF 0%, #D324A8 100%);
  color: #fff;
  font-weight: 550px;
  border: none;
  border-radius: 8px;
  padding: 0px 10px;
  margin-left: 0px;
  font-size: 15px;
  height: 40px;
  box-shadow: 0 2px 8px #551DFF22;
  cursor: pointer;
  transition: background 0.2s, box-shadow 0.2s;
  max-width: 84px;
}

/*
.custom-input{
  width: 70%;
}*/

.get-otp-btn {
 background: linear-gradient(90deg, #47ff53 0%, #2f95ff 100%);
  color: #fff;
  font-weight: 550;
  border: none;
  border-radius: 8px;
  padding: 0 5px;
  margin-left: 0px;
  font-size: 1rem;
 /* height: 32px;*/
  box-shadow: 0 2px 8px #47ff5322;
  cursor: pointer;
  transition: background 0.2s, box-shadow 0.2s;
  max-width: 95px;
}

</style>

<body>
  <!-- Header -->
  {{> header}}

  <div class="main-container">
    <!-- Sidebar -->
    {{> sidebar}}
    <main class="main-content">
      <h1 class="page-title">KYC Verification</h1>

      <form class="kyc-form colorful" id="kycForm" enctype="multipart/form-data">
        <!-- Step 1: Personal Information -->
        <div class="kyc-step" id="kycStep1">
          <div class="kyc-section">
            <div class="kyc-section-title">
              <i class="fas fa-user"></i> Personal Information
            </div>
            <div class="kyc-fields-grid">
              <div class="form-group">
                <label for="fullName">Full Name *</label>
                <input type="text" id="fullName" name="fullName" class="kyc-input" placeholder="Enter full name"
                  required>
              </div>
              <div class="form-group">
                <label for="dob">Date of Birth *</label>
                <input type="date" id="dob" name="dob" class="kyc-input" required>
              </div>
              <div class="form-group">
                <label for="state">State *</label>
                <input type="text" id="state" name="state" class="kyc-input" placeholder="State" required>
              </div>
              <div class="form-group">
                <label for="city">City *</label>
                <input type="text" id="city" name="city" class="kyc-input" placeholder="City" required>
              </div>
              <div class="form-group">
                <label for="postalCode">Postal Code *</label>
                <input type="text" id="postalCode" name="postalCode" class="kyc-input" placeholder="Postal Code"
                  required>
                <small id="postalCodeMessage" style="color: #551DFF;"></small>
              </div>
              <div class="form-group full-width">
                <label for="address">Full Address *</label>
                <textarea id="address" name="address" class="kyc-input" placeholder="Full Address" rows="3"
                  required></textarea>
              </div>
            </div>
          </div>
          <div class="kyc-submit-section" style="text-align:right;">
            <button type="button" class="kyc-submit-btn" id="kycStep1Next">Save & Next <i
                class="fas fa-arrow-right"></i></button>
          </div>
        </div>
        <!-- Step 2: Shop Details & Workers -->
        <div class="kyc-step" id="kycStep2" style="display:none;">
          <div class="kyc-section">
            <div class="kyc-section-title">
              <i class="fas fa-store"></i> Shop Details & Workers
            </div>
            <div class="kyc-fields-grid">
              <div class="form-group">
                <label for="shopName">Shop Name *</label>
                <input type="text" id="shopName" name="shopName" class="kyc-input" placeholder="Shop Name" required>
              </div>
              <div class="form-group full-width">
                <label for="shopAddress">Shop Address *</label>
                <textarea id="shopAddress" name="shopAddress" class="kyc-input" placeholder="Shop Address" rows="3"
                  required></textarea>
              </div>
              <div class="form-group">
                <label for="numWorkers">Number of Workers</label>
                <input type="number" id="numWorkers" name="numWorkers" class="kyc-input" min="0" placeholder="0">
              </div>
            </div>
            <div class="kyc-workers-section">
              <label>Workers' Details</label>
              <div id="workersContainer" class="workers-container">
                <!-- Workers will be added here dynamically -->
              </div>
              <button type="button" id="addWorkerBtn" class="add-worker-btn">
                <i class="fas fa-plus"></i> Add Worker
              </button>
            </div>
          </div>
          <div class="kyc-submit-section" style="display:flex; justify-content:space-between;">
            <button type="button" class="kyc-submit-btn" id="kycStep2Back"><i class="fas fa-arrow-left"></i>
              Back</button>
            <button type="button" class="kyc-submit-btn" id="kycStep2Next">Save & Next <i
                class="fas fa-arrow-right"></i></button>
          </div>
        </div>
        <!-- Step 3: KYC Documents -->
        <div class="kyc-step" id="kycStep3" style="display:none;">
          <div class="kyc-section">
            <div class="kyc-section-title">
              <i class="fas fa-id-card"></i> KYC Documents
            </div>
            <div class="kyc-fields-grid">
              <div class="form-group">
                <label for="adhar_no">Aadhaar Number *</label>
                <input type="text" maxlength="12" id="adhar_no" name="adhar_no" class="kyc-input custom-input"
                  placeholder="Enter 12-digit Aadhaar number" pattern="\d{12}" required>
                  <button class="get-otp-btn" id="getOtpBtn" style="display: none;">Get OTP</button>
                <small id="aadhaarVerificationMessage" style="color: #551DFF;"></small>
                 <div class="otp-fields" id="otpFields" style="display: none;">
            <input type="text" maxlength="1" class="otp-box"/>
            <input type="text" maxlength="1" class="otp-box"/>
            <input type="text" maxlength="1" class="otp-box"/>
            <input type="text" maxlength="1" class="otp-box"/>
            <input type="text" maxlength="1" class="otp-box"/>
            <input type="text" maxlength="1" class="otp-box"/>

            <button class="verify-btn" id="verifyOtpBtn"><span>Verify</span></button>
          </div>
          
              </div>
              
              <div class="form-group">
                <label for="aadhaarCard">Aadhaar Card *</label>
                <input type="file" id="aadhaarCard" name="aadhaarCard" class="kyc-input"
                  accept="image/*,application/pdf">
                <small>Current: <span id="aadhaarCardCurrent"></span></small>
              </div>
              <div class="form-group">
                <label for="shopLicence">Shop Licence </label>
                <input type="file" id="shopLicence" name="shopLicence" class="kyc-input"
                  accept="image/*,application/pdf">
                <small>Current: <span id="shopLicenceCurrent"></span></small>
              </div>
              <div class="form-group">
                <label for="panCard">PAN Card </label>
                <input type="file" id="panCard" name="panCard" class="kyc-input" accept="image/*,application/pdf">
                <small>Current: <span id="panCardCurrent"></span></small>
              </div>
            </div>
          </div>
          <div class="kyc-submit-section" style="display:flex; justify-content:space-between;">
            <button type="button" class="kyc-submit-btn" id="kycStep3Back"><i class="fas fa-arrow-left"></i>
              Back</button>
            <button type="submit" class="kyc-submit-btn" id="kycStep3Submit">
              <i class="fas fa-check"></i> Submit KYC
            </button>
          </div>
        </div>
        <div class="loader" id="formLoader"></div>
      </form>
    </main>
  </div>

  <script>
    function showNotification(message, type = 'info') {
      toastr.options = { timeOut: 3000, positionClass: 'toast-top-right' };
      if (type === 'success') toastr.success(message);
      else if (type === 'error') toastr.error(message);
      else toastr.info(message);
    }

    function addWorkerField(name = '', phone = '', index) {
      const workersContainer = document.getElementById('workersContainer');
      const workerField = document.createElement('div');
      workerField.className = 'worker-field';
      workerField.innerHTML = `
                <div class="form-group">
                    <label for="workerName${index}">Worker Name</label>
                    <input type="text" id="workerName${index}" name="workerName${index}" class="kyc-input" placeholder="Enter worker name" value="${name}">
                </div>
                <div class="form-group">
                    <label for="workerPhone${index}">Phone Number</label>
                    <input type="tel" id="workerPhone${index}" name="workerPhone${index}" class="kyc-input" placeholder="Enter phone number" value="${phone}">
                </div>
                <button type="button" class="remove-worker-btn" onclick="removeWorkerField(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
      workersContainer.appendChild(workerField);
    }

    function removeWorkerField(button) {
      const workerField = button.closest('.worker-field');
      workerField.remove();
      updateNumWorkers();
    }

    function updateNumWorkers() {
      const workersContainer = document.getElementById('workersContainer');
      const numWorkersInput = document.getElementById('numWorkers');
      if (workersContainer && numWorkersInput) {
        numWorkersInput.value = workersContainer.children.length;
      }
    }

    function updateWorkersFields(numWorkers) {
      const workersContainer = document.getElementById('workersContainer');
      if (!workersContainer) return;
      const currentWorkers = workersContainer.children.length;
      if (numWorkers > currentWorkers) {
        for (let i = currentWorkers; i < numWorkers; i++) {
          addWorkerField('', '', i);
        }
      } else if (numWorkers < currentWorkers) {
        const workersToRemove = currentWorkers - numWorkers;
        for (let i = 0; i < workersToRemove; i++) {
          const lastWorker = workersContainer.lastElementChild;
          if (lastWorker) lastWorker.remove();
        }
      }
      updateNumWorkers();
    }
    async function verifyAadhaarImage(file, adharNo) {
      const aadhaarVerificationMessage = document.getElementById('aadhaarVerificationMessage');
      aadhaarVerificationMessage.textContent = 'Verifying Aadhaar...';
      try {
        const { data: { text } } = await Tesseract.recognize(file, 'eng', {
          logger: m => console.log('Tesseract progress:', m)
        });
        console.log('Extracted text from Aadhaar:', text);
        const extractedNumber = text.match(/\d{4}\s*\d{4}\s*\d{4}/)?.[0].replace(/\s/g, '');
        if (extractedNumber && extractedNumber === adharNo) {
          aadhaarVerificationMessage.textContent = 'Aadhaar verified successfully!';
          aadhaarVerificationMessage.style.color = '#47ff53';
          return true;
        } else {
          aadhaarVerificationMessage.textContent = 'Aadhaar verification failed. Number does not match.';
          aadhaarVerificationMessage.style.color = '#ef4444';
          return false;
        }
      } catch (error) {
        console.error('Error verifying Aadhaar:', error);
        aadhaarVerificationMessage.textContent = 'Error verifying Aadhaar image';
        aadhaarVerificationMessage.style.color = '#ef4444';
        return false;
      }
    }

    async function sendAadhaarOtp(aadhaarNumber) {
      try {
        const response = await fetch('/kyc/send-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ aadhaarNumber })
        });
        const result = await response.json();
        console.log('sendAadhaarOtp response:', result);
        if (response.ok) {
          showNotification(result.message || 'OTP sent successfully!', 'success');
          return true;
        } else {
          showNotification(result.message || 'Failed to send OTP', 'error');
          return false;
        }
      } catch (error) {
        console.error('Error sending OTP:', error);
        showNotification('Error sending OTP: ' + error.message, 'error');
        return false;
      }
    }

    async function verifyAadhaarOtp(otp) {
      try {
        const response = await fetch('/kyc/verify-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ otp })
        });
        const result = await response.json();
        console.log('verifyAadhaarOtp response:', result);
        if (response.ok) {
          showNotification(result.message || 'OTP verified successfully!', 'success');
          return true;
        } else {
          showNotification(result.message || 'Invalid OTP', 'error');
          return false;
        }
      } catch (error) {
        console.error('Error verifying OTP:', error);
        showNotification('Error verifying OTP: ' + error.message, 'error');
        return false;
      }
    }

    async function fetchKycData() {
      try {
        const response = await fetch('/kyc/data', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });
        const result = await response.json();
        console.log('fetchKycData response:', result);
        if (response.ok) {
          const data = result.data;
          document.getElementById('fullName').value = data.fullName || '';
          document.getElementById('dob').value = data.dob || '';
          document.getElementById('state').value = data.state || '';
          document.getElementById('city').value = data.city || '';
          document.getElementById('postalCode').value = data.postalCode || '';
          document.getElementById('address').value = data.address || '';
          document.getElementById('shopName').value = data.shopName || '';
          document.getElementById('shopAddress').value = data.shopAddress || '';
          document.getElementById('numWorkers').value = data.numWorkers || 0;
          document.getElementById('adhar_no').value = data.adhar_no || '';

          const aadhaarCardCurrent = document.getElementById('aadhaarCardCurrent');
          const shopLicenceCurrent = document.getElementById('shopLicenceCurrent');
          const panCardCurrent = document.getElementById('panCardCurrent');

          if (aadhaarCardCurrent) {
          /*   aadhaarCardCurrent.textContent = data.adhar_photo ? path.basename(data.adhar_photo) : 'None';*/
          aadhaarCardCurrent.textContent = data.adhar_photo ? data.adhar_photo.split('/').pop() : 'None';


          } else {
            console.error('Element #aadhaarCardCurrent not found');
          }
          if (shopLicenceCurrent) {
            shopLicenceCurrent.textContent = data.shop_licence ? data.shop_licence.split('/').pop() : 'None';
          } else {
            console.error('Element #shopLicenceCurrent not found');
          }
          if (panCardCurrent) {
            panCardCurrent.textContent = data.pan_photo ? data.pan_photo.split('/').pop() : 'None';
          } else {
            console.error('Element #panCardCurrent not found');
          }

          const workersContainer = document.getElementById('workersContainer');
          workersContainer.innerHTML = '';
          data.workers.forEach(worker => addWorkerField(worker.workerName, worker.workerPhone, worker.index));
          updateNumWorkers();
        } else {
          showNotification('Failed to load KYC data: ' + result.message, 'error');
        }
      } catch (error) {
        console.error('Error in fetchKycData:', error);
        showNotification('Error loading KYC data: ' + error.message, 'error');
      }
    }


    async function fetchLocationByPincode(pincode) {
      const postalCodeMessage = document.getElementById('postalCodeMessage');
      postalCodeMessage.textContent = '';
      if (!/^\d{6}$/.test(pincode)) {
        postalCodeMessage.textContent = 'Please enter a valid 6-digit PIN code';
        return;
      }
      try {
        postalCodeMessage.textContent = 'Fetching location...';
        const response = await fetch(`/kyc/pincode?pincode=${pincode}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });
        const result = await response.json();
        console.log('fetchLocationByPincode response:', result);
        if (response.ok) {
          document.getElementById('city').value = result.data.city;
          document.getElementById('state').value = result.data.state;
          postalCodeMessage.textContent = 'Location fetched successfully!';
          postalCodeMessage.style.color = '#47ff53';
        } else {
          postalCodeMessage.textContent = result.message || 'Invalid PIN code';
          postalCodeMessage.style.color = '#ef4444';
        }
      } catch (error) {
        postalCodeMessage.textContent = 'Error fetching location';
        postalCodeMessage.style.color = '#ef4444';
        console.error('Error fetching PIN code:', error);
      }
    }
    document.addEventListener('DOMContentLoaded', function () {
      const steps = [
        document.getElementById('kycStep1'),
        document.getElementById('kycStep2'),
        document.getElementById('kycStep3')
      ];
      let currentStep = 0;
      const formLoader = document.getElementById('formLoader');
      let aadhaarVerified = false;
      function showStep(idx) {
        steps.forEach((step, i) => {
          if (step) step.style.display = i === idx ? '' : 'none';
        });
        currentStep = idx;
      }

      function validateStep(idx) {
        const requiredInputs = steps[idx].querySelectorAll('[required]');
        let valid = true;
        requiredInputs.forEach(input => {
          if (input.type === 'file') {
            if (!input.files || input.files.length === 0) {
              const currentFile = document.getElementById(`${input.id}Current`)?.textContent;
              if (!currentFile || currentFile === 'None') {
                valid = false;
                input.classList.add('input-error');
              } else {
                input.classList.remove('input-error');
              }
            } else {
              input.classList.remove('input-error');
            }
          } else if (!input.value) {
            valid = false;
            input.classList.add('input-error');
          } else {
            input.classList.remove('input-error');
          }
        });
        return valid;
      }

      // Fetch KYC data on load
      fetchKycData();

      const aadhaarInput = document.getElementById('adhar_no');
      const getOtpBtn = document.getElementById('getOtpBtn');
      const otpFields = document.getElementById('otpFields');
      const verifyOtpBtn = document.getElementById('verifyOtpBtn');

      if (aadhaarInput && getOtpBtn) {
        aadhaarInput.addEventListener('input', () => {
          const aadhaarNumber = aadhaarInput.value.trim();
          if (/^\d{12}$/.test(aadhaarNumber)) {
            getOtpBtn.style.display = 'inline-block';
          } else {
            getOtpBtn.style.display = 'none';
            otpFields.style.display = 'none';
            verifyOtpBtn.style.display = 'none';
            document.getElementById('aadhaarVerificationMessage').textContent = '';
          }
        });
      }

      // Handle Send OTP
      if (getOtpBtn) {
        getOtpBtn.addEventListener('click', async () => {
          const aadhaarNumber = aadhaarInput.value.trim();
          if (/^\d{12}$/.test(aadhaarNumber)) {
            const success = await sendAadhaarOtp(aadhaarNumber);
            if (success) {
              getOtpBtn.style.display = 'none';
              otpFields.style.display = 'flex';
              verifyOtpBtn.style.display = 'inline-block';
            }
          } else {
            showNotification('Please enter a valid 12-digit Aadhaar number.', 'error');
          }
        });
      }

      // Handle OTP input and auto-focus
      const otpBoxes = document.querySelectorAll('.otp-box');
      otpBoxes.forEach((box, index) => {
        box.addEventListener('input', (e) => {
          if (e.target.value.length === 1 && index < otpBoxes.length - 1) {
            otpBoxes[index + 1].focus();
          }
          // Enable verify button when all OTP boxes are filled
          const otp = Array.from(otpBoxes).map(box => box.value).join('');
          verifyOtpBtn.disabled = otp.length !== otpBoxes.length;
        });
        box.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            otpBoxes[index - 1].focus();
          }
        });
      });

      // Handle Verify OTP
      if (verifyOtpBtn) {
        verifyOtpBtn.addEventListener('click', async () => {
          const otp = Array.from(otpBoxes).map(box => box.value).join('');
          if (otp.length === otpBoxes.length) {
            const success = await verifyAadhaarOtp(otp);
            if (success) {
              aadhaarVerified = true;
              document.getElementById('aadhaarVerificationMessage').textContent = 'Aadhaar OTP verified successfully!';
              document.getElementById('aadhaarVerificationMessage').style.color = '#47ff53';
              otpFields.style.display = 'none';
              verifyOtpBtn.style.display = 'none';
            } else {
              document.getElementById('aadhaarVerificationMessage').textContent = 'Invalid OTP. Please try again.';
              document.getElementById('aadhaarVerificationMessage').style.color = '#ef4444';
            }
          } else {
            showNotification('Please enter the complete OTP.', 'error');
          }
        });
      }
       
      const postalCodeInput = document.getElementById("postalCode");
      if (postalCodeInput) {
        let timeOut;
        postalCodeInput.addEventListener('input', () => {
          clearTimeout(timeOut);
          timeOut = setTimeout(() => {
            const pincode = postalCodeInput.value.trim();
            if (pincode) fetchLocationByPincode(pincode);
          }, 500);
        })
      }


      const aadhaarCardInput = document.getElementById('aadhaarCard');
      if (aadhaarCardInput) {
        aadhaarCardInput.addEventListener('change', async () => {
          const file = aadhaarCardInput.files[0];
          const adharNo = document.getElementById('adhar_no').value.trim();
          if (file && adharNo && /^\d{12}$/.test(adharNo)) {
            aadhaarVerified = await verifyAadhaarImage(file, adharNo);
          } else {
            document.getElementById('aadhaarVerificationMessage').textContent = 'Please enter a valid 12-digit Aadhaar number';
            document.getElementById('aadhaarVerificationMessage').style.color = '#ef4444';
            aadhaarVerified = false;
          }
        });
      }

      // Step 1 Next
      const step1Next = document.getElementById('kycStep1Next');
      if (step1Next) {
        step1Next.addEventListener('click', function () {
          if (validateStep(0)) {
            showStep(1);
          } else {
            showNotification('Please fill all required fields in this step.', 'error');
          }
        });
      }

      // Step 2 Back/Next
      const step2Back = document.getElementById('kycStep2Back');
      const step2Next = document.getElementById('kycStep2Next');
      if (step2Back) {
        step2Back.addEventListener('click', function () {
          showStep(0);
        });
      }
      if (step2Next) {
        step2Next.addEventListener('click', function () {
          if (validateStep(1)) {
            showStep(2);
          } else {
            showNotification('Please fill all required fields in this step.', 'error');
          }
        });
      }

      // Step 3 Back
      const step3Back = document.getElementById('kycStep3Back');
      if (step3Back) {
        step3Back.addEventListener('click', function () {
          showStep(1);
        });
      }

      // Add Worker
      const addWorkerBtn = document.getElementById('addWorkerBtn');
      if (addWorkerBtn) {
        addWorkerBtn.addEventListener('click', () => {
          const workersContainer = document.getElementById('workersContainer');
          addWorkerField('', '', workersContainer.children.length);
          updateNumWorkers();
        });
      }

      // Num Workers Input
      const numWorkersInput = document.getElementById('numWorkers');
      if (numWorkersInput) {
        numWorkersInput.addEventListener('input', () => {
          const numWorkers = parseInt(numWorkersInput.value) || 0;
          updateWorkersFields(numWorkers);
        });
      }

      // Form Submission
      const kycForm = document.getElementById('kycForm');
     if (kycForm) {
      kycForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        if (!validateStep(2)) {
          showNotification('Please upload all required documents.', 'error');
          return;
        }

        // Validate Aadhaar number
        const adharNo = document.getElementById('adhar_no').value.trim();
        if (!/^\d{12}$/.test(adharNo)) {
          showNotification('Please enter a valid 12-digit Aadhaar number.', 'error');
          document.getElementById('adhar_no').classList.add('input-error');
          return;
        }

        formLoader.style.display = 'block';
        const formData = new FormData();
        // Add text fields
        const textFields = ['fullName', 'dob', 'state', 'city', 'postalCode', 'address', 'shopName', 'shopAddress', 'numWorkers', 'adhar_no'];
        textFields.forEach(field => {
          const value = document.getElementById(field)?.value.trim();
          if (value) formData.append(field, value);
        });
        formData.append('aadhaarVerified', aadhaarVerified.toString());

        // Add worker fields only if valid
        const workersContainer = document.getElementById('workersContainer');
        const workerInputs = workersContainer.querySelectorAll('.worker-field');
        workerInputs.forEach((worker, index) => {
          const nameInput = worker.querySelector(`[name="workerName${index}"]`);
          const phoneInput = worker.querySelector(`[name="workerPhone${index}"]`);
          if (nameInput?.value.trim() && phoneInput?.value.trim()) {
            formData.append(`workerName${index}`, nameInput.value.trim());
            formData.append(`workerPhone${index}`, phoneInput.value.trim());
          }
        });

        // Add files
        const fileFields = ['aadhaarCard', 'shopLicence', 'panCard'];
        fileFields.forEach(field => {
          const input = document.getElementById(field);
          if (input?.files?.length > 0) {
            formData.append(field, input.files[0]);
          }
        });

        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 60000); // Increased to 60s
          console.log('Submitting FormData:', Array.from(formData.entries()));
          const response = await fetch('/kyc/submit', {
            method: 'POST',
            body: formData,
            credentials: 'include',
            signal: controller.signal
          });
          clearTimeout(timeoutId);
          const result = await response.json();
          console.log('kycForm submit response:', result);
          if (response.ok) {
            showNotification(result.message || 'KYC form submitted successfully!', 'success');
            kycForm.reset();
            document.getElementById('workersContainer').innerHTML = '';
            document.getElementById('aadhaarCardCurrent').textContent = 'None';
            document.getElementById('shopLicenceCurrent').textContent = 'None';
            document.getElementById('panCardCurrent').textContent = 'None';
            document.getElementById('aadhaarVerificationMessage').textContent = '';
            aadhaarVerified = false;
            showStep(0);
          } else {
            showNotification(result.message || 'Failed to submit KYC', 'error');
          }
        } catch (error) {
          console.error('Error submitting KYC:', error);
          if (error.name === 'AbortError') {
            showNotification('Submission timed out. Please try again.', 'error');
          } else {
            showNotification('Error submitting KYC: ' + error.message, 'error');
          }
        } finally {
          formLoader.style.display = 'none';
        }
      });
    }

      // Show first step on load
      showStep(0);
    });
  </script>
  {{> profile}}


    <script src="/js/all.js"></script>
</body>

</html>