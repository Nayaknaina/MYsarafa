<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarafa Community Dashboard</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <style>
        .upload-wrapper {
            display: flex;
            gap: 24px;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .upload-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 6px 24px rgba(47, 149, 255, 0.13);
            padding: 22px;
            flex: 1 1 340px;
            max-width: 520px;
            border-bottom: 4px solid #551DFF;
        }

        .upload-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-input {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid #bdbdbd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .upload-input:focus {
            outline: none;
            border-color: #2f95ff;
            box-shadow: 0 0 0 3px rgba(47, 149, 255, 0.12);
        }

        .upload-hint {
            color: #6b7280;
            font-size: 0.95rem;
            margin-top: 6px;
        }

        .upload-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 12px;
        }

        .upload-btn {
            background: linear-gradient(245deg, #D324A8 -67.04%, #551DFF 129.05%);
            color: #fff;
            border: none;
            border-radius: 22px;
            padding: 10px 18px;
            cursor: pointer;
            font-weight: 600;
        }

        .upload-btn:hover {
            filter: brightness(1.05);
        }

        .preview-wrap {
            display: none;
            margin-top: 14px;
        }

        .preview-label {
            font-weight: 600;
            margin-bottom: 6px;
        }

        .preview-img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.10);
        }

        .community-info {
            flex: 1 1 300px;
            max-width: 580px;
            background: #fff;
            border-radius: 12px;
            padding: 22px;
            box-shadow: 0 6px 24px rgba(85, 29, 255, 0.13);
            position: relative;
            overflow: hidden;
        }

        .community-info::before {
            content: "";
            position: absolute;
            top: -60px;
            right: -60px;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, #D324A8 0%, #551DFF 80%, transparent 100%);
            opacity: .12;
        }

        .community-title {
            font-weight: 800;
            font-size: 1.2rem;
            color: #1976d2;
            margin-bottom: 10px;
        }

        .community-text {
            color: #374151;
            line-height: 1.6;
        }

        .community-list {
            margin-top: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .community-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f6faff;
            border: 1px solid #e3f0ff;
            border-radius: 10px;
            padding: 10px;
            font-weight: 600;
            color: #1976d2;
        }

        @media (max-width: 700px) {
            .community-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    {{> header}}

    <div class="main-container">
        {{> sidebar}}

       <main class="main-content">
            <div class="upload-wrapper">
                <section class="upload-card">
                    <div class="upload-title"><i class="fas fa-cloud-upload-alt"></i> Upload Payment Screenshot</div>
                    <form id="paymentForm" enctype="multipart/form-data">
                        <label for="Communityselection">Select Community</label>
                        <select name="community" id="Communityselection" class="upload-input" required>
                            <option value="">Select</option>
                            {{#each groups}}
                            <option value="{{this._id}}" {{#if (eq this._id ../groupId)}}selected{{/if}}>{{this.g_name}}</option>
                            {{/each}}
                        </select><br><br>
                        <label for="upiId">UPI ID</label>
                        <input type="text" id="upiId" name="upiId" class="upload-input" placeholder="Enter UPI ID" required><br><br>
                        <label for="amount">Amount</label>
                        <input type="text" id="amount" name="amount" class="upload-input"  placeholder="Enter amount" required><br><br>
                        <label for="method">Payment Method</label>
                        <select id="method" name="method" class="upload-input" required>
                            <option value="">Select Method</option>
                            <option value="UPI">UPI</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Cash">Cash</option>
                        </select><br><br>
                        <label for="paymentScreenshot">Select Screenshot</label>
                        <input type="file" id="paymentScreenshot" name="paymentScreenshot" class="upload-input" accept="image/*,application/pdf" required>
                        <div class="upload-hint">Accepted formats: JPG, PNG, PDF. Image files will show a preview.</div>
                        <div class="upload-actions">
                            <button type="submit" class="upload-btn" id="submitPaymentProof"><i class="fas fa-paper-plane"></i> Submit</button>
                        </div>
                        <div class="preview-wrap" id="paymentPreview">
                            <div class="preview-label">Preview</div>
                            <img id="paymentPreviewImg" class="preview-img" alt="Screenshot Preview" />
                        </div>
                    </form>
                </section>
                <aside class="community-info">
                    <div class="community-title">Sarafa Community</div>
                    <p class="community-text">We are a vibrant network of members collaborating to uplift each other,
                        share opportunities, and celebrate together. Your participation helps us organize events,
                        support initiatives, and strengthen our bonds.</p>
                    <div class="community-list">
                        <div class="community-item"><i class="fas fa-heart"></i> Stronger Connections</div>
                        <div class="community-item"><i class="fas fa-bolt"></i> Quick Support</div>
                        <div class="community-item"><i class="fas fa-calendar"></i> Engaging Events</div>
                        <div class="community-item"><i class="fas fa-star"></i> Member Spotlight</div>
                    </div>
                </aside>
            </div>
        </main>
    </div>

<script>
        $(document).ready(function () {
            const paymentForm = $('#paymentForm');
            const paymentScreenshot = $('#paymentScreenshot');
            const paymentPreview = $('#paymentPreview');
            const paymentPreviewImg = $('#paymentPreviewImg');
            const fileNameText = $('#fileName');
            const communitySelection = $('#Communityselection');
            const submitButton = $('#submitPaymentProof');
            const upiIdInput = $('#upiId');
            const amountInput = $('#amount');
            const methodInput = $('#method');

            function showNotification(message, type) {
                toastr[type](message);
            }

            // Enable/disable submit button based on form validity
            function updateSubmitButton() {
                const isValid = communitySelection.val() && upiIdInput.val() && amountInput.val() && methodInput.val() && paymentScreenshot[0].files.length > 0;
                submitButton.prop('disabled', !isValid);
            }

            // Pre-select group from query parameter
            const urlParams = new URLSearchParams(window.location.search);
            const groupId = urlParams.get('groupId');
            if (groupId) {
                communitySelection.val(groupId);
                updateSubmitButton();
            }

            // Update submit button on input changes
            communitySelection.on('change', updateSubmitButton);
            upiIdInput.on('input', updateSubmitButton);
            amountInput.on('input', updateSubmitButton);
            methodInput.on('change', updateSubmitButton);
            paymentScreenshot.on('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    fileNameText.text(`Selected: ${file.name}`);
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            paymentPreviewImg.attr('src', e.target.result);
                            paymentPreview.show();
                        };
                        reader.readAsDataURL(file);
                    } else {
                        paymentPreviewImg.attr('src', '');
                        paymentPreview.show();
                    }
                } else {
                    fileNameText.text('');
                    paymentPreview.hide();
                }
                updateSubmitButton();
            });

            // Form submission
            paymentForm.on('submit', async function (e) {
                e.preventDefault();
                submitButton.prop('disabled', true).text('Submitting...');

                const formData = new FormData(this);
                formData.append('groupId', communitySelection.val());
             
                try {
                    const response = await fetch('/pay/SS-upload', {
                        method: 'POST',
                        body: formData,
                        credentials: 'include',
                        headers: {
                            'Authorization': `Bearer ${document.cookie.split('token=')[1]?.split(';')[0] || ''}`
                        }
                    });
                    const result = await response.json();
                    if (response.ok && result.success) {
                        showNotification('Screenshot uploaded successfully', 'success');
                        setTimeout(() => window.location.href = '/user-app/dashboard', 2000);
                    } else {
                        showNotification(result.message || 'Failed to upload screenshot', 'error');
                        submitButton.prop('disabled', false).text('Submit');
                    }
                } catch (error) {
                    showNotification('Error uploading screenshot: ' + error.message, 'error');
                    submitButton.prop('disabled', false).text('Submit');
                }
            });
        });
    </script>
    <script>
        const communitySelection = document.getElementById('Communityselection');
        const coverImagePreview = document.getElementById('coverImagePreview');
        const groupNamePreview = document.getElementById('groupNamePreview');
        const groupDescriptionPreview = document.getElementById('groupDescriptionPreview');

        function showNotification(message, type) {
            toastr[type](message);
        }

        if (communitySelection) {
            communitySelection.addEventListener('change', async () => {
                const groupId = communitySelection.value;
                if (!groupId) {
                    groupNamePreview.textContent = 'Not provided';
                    groupDescriptionPreview.textContent = 'No description available';
                    return;
                }

                try {
                    const response = await fetch(`/Groups/groups/${groupId}`, {
                        method: 'GET',
                        credentials: 'include',
                        headers: { 'Authorization': `Bearer ${document.cookie.split('token=')[1]?.split(';')[0]}` }
                    });
                    const result = await response.json();
                    console.log(result)
                    if (response.ok && result.success) {
                      
                 
                           document.getElementById('amount').value = `â‚¹ ${result.group.amount}`;
                    } else {
                        showNotification(result.message || 'Failed to load group details', 'error');
                    }
                    
                } catch (error) {
                    showNotification('Error loading group details: ' + error.message, 'error');
                }
            });
        }
    </script>
</body>

</html>